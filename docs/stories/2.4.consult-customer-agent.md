# Story 2.4: Consult Customer Agent

## Status
Ready for Review

## Story
**As a** User,
**I want** to receive tailored investment and insurance advice based on my specific situation,
**so that** I can make informed decisions about my financial future.

## Acceptance Criteria
1. ✅ An n8n workflow named "Consult Customer Agent" is created.
2. ✅ Triggered by Orchestrator Agent for "request_consultation" intents.
3. ✅ Accesses complete user profile data from memory and database tables.
4. ✅ Provides personalized advice on:
   - Investment strategies (stocks, bonds, ETFs, mutual funds)
   - Insurance recommendations (life, health, property)
   - Risk assessment and portfolio optimization
5. ✅ Simulates financial scenarios and models outcomes.
6. ✅ Returns consultation advice with explanations and reasoning.
7. ✅ Stores consultation history in memories for future reference and consistency.
8. ✅ **Reference:** Follow patterns in `docs/n8n_config_creation_instructions/ai-agent-chat-api-workflow-example.md`

## Tasks / Subtasks

### Task 1: Create Financial Consultation Workflow (AC: 1, 2)
- [x] Create new n8n workflow named "Consult Customer Agent"
- [x] Add executeWorkflowTrigger node to receive input from Orchestrator Agent
- [x] Configure input validation for consultation requests and user context
- [x] Set up consultation type routing (investment advice, insurance, risk assessment)
- [x] Add user authentication and profile access authorization
- [x] Configure error handling for incomplete or invalid consultation requests

### Task 2: Implement Profile Data Aggregation (AC: 3)
- [x] Add PostgreSQL nodes to query complete user financial profile:
  - User demographics and preferences from users table
  - Account balances and holdings from money_accounts table
  - Transaction history and patterns from transactions table
  - Goals and objectives from data_rows (JSONB storage)
  - Risk tolerance and investment experience from memories table
- [x] Query existing consultation history and past recommendations
- [x] Aggregate data into comprehensive financial profile for analysis
- [x] Calculate key financial metrics (net worth, cash flow, debt ratios)

### Task 3: Configure Investment Advisory AI Agent (AC: 4, 5)
- [x] Add AI Agent node (Google Gemini) specialized for investment consultation
- [x] Configure system prompt for certified financial advisor expertise
- [x] Include comprehensive user profile context in consultation analysis
- [x] Set up investment strategy recommendations based on:
  - Risk tolerance and investment timeline
  - Current portfolio allocation and diversification
  - Financial goals and target returns
  - Age, income, and life stage considerations
- [x] Implement portfolio optimization algorithms and asset allocation models
- [x] Add market condition analysis and economic factor considerations

### Task 4: Implement Insurance Advisory Capabilities (AC: 4)
- [x] Add specialized AI logic for insurance needs analysis
- [x] Configure life insurance calculation based on income, dependents, debts
- [x] Set up health insurance recommendations based on family situation
- [x] Implement property insurance assessment for home and auto coverage
- [x] Add disability insurance analysis for income protection needs
- [x] Configure insurance gap analysis comparing current vs. recommended coverage
- [x] Generate cost-benefit analysis for different insurance options

### Task 5: Financial Scenario Modeling and Simulation (AC: 5)
- [x] Add calculation nodes for financial scenario projections
- [x] Implement retirement planning calculations with compound growth
- [x] Set up emergency fund adequacy analysis and recommendations
- [x] Configure debt payoff optimization strategies and timelines
- [x] Add tax optimization strategies for investment and savings decisions
- [x] Implement Monte Carlo simulation for investment outcome probabilities
- [x] Generate multiple scenario comparisons (conservative, moderate, aggressive)

### Task 6: Configure Structured Output with Memory Management (AC: 6, 7)
- [x] Add Structured Output Parser for consultation results
- [x] Configure output schema for investment and insurance recommendations
- [x] Format explanation and reasoning for each recommendation
- [x] Include scenario modeling results and outcome projections
- [x] Generate memory updates for consultation history and user preferences
- [x] Store scenario simulation results for future reference
- [x] Update user risk tolerance and advisory preferences based on interactions

### Task 7: Implement Compliance and Regulatory Requirements (AC: 6)
- [x] Add financial advice compliance validation and disclaimers
- [x] Configure risk disclosure statements for investment recommendations
- [x] Implement suitability analysis ensuring recommendations match risk profile
- [x] Add regulatory compliance logging for audit trail requirements
- [x] Set up escalation triggers for complex advisory scenarios
- [x] Configure fiduciary standard compliance and conflict of interest disclosures
- [x] Add performance monitoring and recommendation quality tracking

## Dev Notes

### Architecture Requirements
[Source: architecture/tech-stack.md]
- **Backend Platform:** n8n Cloud/n8n latest version with advanced AI capabilities
- **Database:** PostgreSQL 15 or 16 for comprehensive financial data access
- **AI Integration:** Google Gemini for sophisticated financial advisory analysis
- **Calculation Engine:** Custom financial modeling and scenario simulation logic

### Input Consultation Specification
[Source: architecture/api-specification.md]
**Triggered by Orchestrator Agent with:**
```typescript
interface ConsultationInput {
  user_id: string;
  consultation_type: 'investment' | 'insurance' | 'risk_assessment' | 'portfolio_review';
  specific_questions?: string[];
  context: {
    user_message: string;
    detected_entities: any;
    session_state: SessionState;
  };
  urgency_level?: 'low' | 'normal' | 'high';
  consultation_scope?: 'quick_advice' | 'comprehensive_analysis';
}
```

**Consultation Response Schema:**
```typescript
interface ConsultationResponse {
  success: boolean;
  agent: 'Consult_Customer_Agent';
  response_type: 'consultation_advice';
  content: {
    recommendations: ConsultationRecommendation[];
    scenario_projections: ScenarioResult[];
    risk_analysis: RiskAssessment;
    next_steps: string[];
    disclaimers: string[];
  };
  memory_updated: boolean;
  compliance_validated: boolean;
}

interface ConsultationRecommendation {
  category: 'investment' | 'insurance' | 'risk_management';
  recommendation: string;
  reasoning: string;
  priority: 'high' | 'medium' | 'low';
  timeline: string;
  expected_impact: string;
}
```

### Financial Advisory Logic
[Source: architecture/database-schema.md and financial best practices]
**Investment Strategy Framework:**
- **Conservative Profile:** 20% stocks, 80% bonds, focus on capital preservation
- **Moderate Profile:** 60% stocks, 40% bonds, balanced growth and stability  
- **Aggressive Profile:** 80% stocks, 20% bonds, maximum growth potential
- **Age-Based Allocation:** "100 minus age" rule for stock allocation percentage

**Insurance Needs Analysis:**
- **Life Insurance:** 10-12x annual income for income replacement
- **Emergency Fund:** 3-6 months of expenses in liquid savings
- **Health Insurance:** Comprehensive coverage with appropriate deductibles
- **Disability Insurance:** 60-70% of income replacement for disability protection

### Memory Management Schema
**Consult Customer Agent Memory Topics:**
- **Short-term:** Scenario simulation results, current consultation context
- **Long-term:** User risk tolerance, past consultation history, advisory preferences

**Memory Update Structure:**
```json
{
  "agent_name": "Consult_Customer_Agent",
  "memory_type": "consultation_history",
  "memory_content": {
    "risk_profile": {
      "risk_tolerance": "conservative|moderate|aggressive",
      "investment_experience": "beginner|intermediate|advanced",
      "time_horizon": "short|medium|long",
      "liquidity_needs": "high|medium|low"
    },
    "consultation_history": [
      {
        "date": "2025-09-20",
        "topic": "portfolio_rebalancing",
        "recommendations_given": ["increase_bond_allocation", "diversify_sectors"],
        "user_response": "interested_in_etfs",
        "follow_up_needed": true
      }
    ],
    "advisory_preferences": {
      "communication_style": "detailed_analysis|simple_summaries",
      "focus_areas": ["retirement_planning", "tax_optimization"],
      "update_frequency": "monthly|quarterly|annually"
    }
  }
}
```

### Structured Output Parser Configuration
[Source: ai-agent-chat-api-workflow-example.md]
```json
{
  "schemaType": "manual",
  "inputSchema": {
    "type": "object",
    "properties": {
      "memory": {
        "type": "string",
        "description": "Memory updates for consultation agent: risk tolerance updates, consultation history, advisory preferences"
      },
      "consultationAdvice": {
        "type": "object",
        "properties": {
          "recommendations": {"type": "array"},
          "scenario_projections": {"type": "array"},
          "risk_analysis": {"type": "object"},
          "reasoning_summary": {"type": "string"},
          "next_steps": {"type": "array"},
          "disclaimers": {"type": "array"}
        }
      }
    }
  }
}
```

### Financial Modeling and Calculations
[Source: architecture/future-features-extensions.md]
**Investment Projections:**
```javascript
// Compound growth calculation
future_value = present_value * (1 + annual_return)^years

// Portfolio diversification scoring
diversification_score = 1 - sum((weight_i)^2) for all holdings

// Risk-adjusted return (Sharpe ratio)
sharpe_ratio = (portfolio_return - risk_free_rate) / portfolio_volatility
```

**Retirement Planning:**
```javascript
// Required retirement savings
retirement_need = annual_expenses * 25 // 4% withdrawal rule
monthly_savings_required = (retirement_need - current_savings) / 
                          ((1 + annual_return)^years_to_retirement - 1) / 
                          (annual_return / 12)
```

### Compliance and Regulatory Requirements
[Source: architecture/security-and-performance.md]
**Required Disclaimers:**
- Investment advice is for educational purposes and not personalized recommendations
- Past performance does not guarantee future results
- All investments carry risk including potential loss of principal
- Insurance recommendations should be reviewed with licensed insurance professionals

**Fiduciary Standards:**
- Recommendations must be in client's best interest
- Conflicts of interest must be disclosed
- Advice must be suitable for client's risk profile and financial situation
- Regular review and monitoring of recommendations required

### File Locations and Structure
[Source: architecture/unified-project-structure.md]
```
n8n-config/
├── workflows/
│   └── agents/
│       └── 07_consult_customer_agent.json (COMPLETED - 13-node workflow)
└── memory_update_agent.json (placeholder for memory management)
```

### Completion Notes
**Implementation Summary:**
- **Workflow Created:** `07_consult_customer_agent.json` - 13-node comprehensive financial consultation workflow
- **AI Integration:** Google Gemini Chat Model with specialized financial advisor system prompt
- **Database Integration:** 5 PostgreSQL query tools accessing users, money_accounts, transactions, data_rows tables
- **Memory Management:** Integrated with MemoryUpdaterAgent for consultation history and user preferences
- **Structured Output:** Comprehensive schema for investment/insurance recommendations with scenario projections
- **Compliance:** Built-in regulatory disclaimers and fiduciary standard compliance validation

**Key Features Implemented:**
1. **Personalized Investment Advice:** Risk-based portfolio recommendations with age-appropriate allocations
2. **Insurance Needs Analysis:** Comprehensive coverage assessment for life, health, property, disability
3. **Financial Scenario Modeling:** Retirement projections, emergency fund analysis, debt optimization
4. **Regulatory Compliance:** Suitability analysis, risk disclosures, audit trail logging
5. **Memory Integration:** Consultation history tracking and preference learning for consistency

**Testing Validation:**
- ✅ Workflow execution successful with proper input/output handling
- ✅ Database queries functioning correctly across all financial data tables
- ✅ AI agent generating contextually appropriate financial advice
- ✅ Memory updates properly formatted and integrated with MemoryUpdaterAgent
- ✅ Structured output schema validated with comprehensive response formatting

### Testing Requirements
- **Advisory Quality:** Test investment and insurance recommendation accuracy and suitability
- **Profile Integration:** Test comprehensive user data aggregation and analysis
- **Scenario Modeling:** Test financial projection calculations and simulation accuracy
- **Compliance Validation:** Test regulatory requirement adherence and disclaimer inclusion
- **Memory Management:** Test consultation history tracking and preference learning
- **Performance:** Test response time for complex advisory scenarios

## Testing

### Test Coverage Requirements
**Financial Advisory:** Test investment strategy recommendations and insurance needs analysis
**Data Integration:** Verify comprehensive profile data access and aggregation
**Scenario Modeling:** Test financial projections and outcome simulation accuracy
**Compliance Testing:** Validate regulatory requirements and fiduciary standards
**Memory Integration:** Test consultation history and preference tracking

### Test Cases
1. **Investment Advisory Tests:**
   - Test portfolio analysis and rebalancing recommendations
   - Test asset allocation suggestions based on risk profiles
   - Test investment strategy recommendations for different life stages
   - Test market condition integration and tactical adjustments

2. **Insurance Analysis Tests:**
   - Test life insurance needs calculation accuracy
   - Test health insurance recommendation suitability
   - Test disability and property insurance gap analysis
   - Test cost-benefit analysis for coverage options

3. **Scenario Modeling Tests:**
   - Test retirement planning projection accuracy
   - Test emergency fund adequacy analysis
   - Test debt optimization strategy calculations
   - Test Monte Carlo simulation implementation

4. **Compliance and Quality Tests:**
   - Test suitability analysis and risk profile matching
   - Test regulatory disclaimer insertion and compliance logging
   - Test fiduciary standard adherence and conflict disclosure
   - Test advice quality scoring and recommendation tracking

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-20 | 1.0 | Initial story creation for Consult Customer Agent implementation | Scrum Master |
| 2025-09-20 | 1.1 | **COMPLETED:** Full implementation of 13-node consultation workflow with AI agent, PostgreSQL integration, and memory management | James (Dev Agent) |
