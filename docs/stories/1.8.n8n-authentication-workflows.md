# Story 1.8: N8N Authentication Workflows

## Status
Draft

## Story
**As a** System Administrator,
**I want** to implement complete n8n authentication workflows for user registration, login, and token management,
**so that** the Flutter app can securely authenticate users and maintain session state through JWT tokens.

## Acceptance Criteria
1. A combined authentication API workflow with route switching handles registration, login, and logout operations via `/webhook/auth` endpoint.
2. A separate JWT middleware workflow provides token validation services for other workflows via `executeWorkflowTrigger`.
3. A token refresh API workflow validates existing JWT tokens and issues new ones via `/webhook/refresh` endpoint.
4. All workflows follow the exact patterns from the provided n8n examples with proper error handling and security measures.
5. Database schema supports the authentication workflows with users table containing id, email, password_hash, created_at fields.

## Tasks / Subtasks

### Task 1: Create Combined Authentication Workflow (AC: 1)
- [ ] Create main authentication workflow with `/webhook/auth` endpoint (POST)
- [ ] Implement route switching based on action parameter (register, login, logout)
- [ ] Add input validation nodes for registration (email format, password strength with uppercase, lowercase, number requirements)
- [ ] Add input validation nodes for login (email format, password presence)
- [ ] Implement user existence checking for registration (prevent duplicates)
- [ ] Add password hashing using SHA256 crypto node for both registration and login
- [ ] Create user insertion with PostgreSQL node returning id, email, created_at
- [ ] Add user lookup and password verification for login flow
- [ ] Implement JWT token generation for successful registration and login
- [ ] Add logout token extraction and verification
- [ ] Configure comprehensive error responses with proper HTTP status codes

### Task 2: Create JWT Middleware Workflow (AC: 2)
- [ ] Create JWT middleware workflow with `executeWorkflowTrigger` (called by other workflows)
- [ ] Add Authorization header extraction from webhook request headers
- [ ] Implement Bearer token format validation and extraction
- [ ] Add JWT token verification using JWT node with proper error handling
- [ ] Return authentication status (authenticated: true/false) to calling workflow
- [ ] Handle all JWT validation errors with appropriate error messages

### Task 3: Create Token Refresh Workflow (AC: 3)
- [ ] Create token refresh workflow with `/webhook/refresh` endpoint (POST)
- [ ] Extract JWT token from Authorization header using code node
- [ ] Verify existing token validity and extract user information
- [ ] Query database to ensure user still exists and is active
- [ ] Generate new JWT token with fresh expiration time
- [ ] Return new token with user information in response
- [ ] Handle token validation and refresh errors appropriately

### Task 4: Update Database Schema (AC: 5)
- [ ] Update DB Init workflow to include users table with proper structure
- [ ] Add users table: id (UUID primary key), email (unique), password_hash, created_at
- [ ] Ensure email field has unique constraint and proper indexing
- [ ] Test database schema with the authentication workflows
- [ ] Verify proper UUID generation and constraints

### Task 5: Configure JWT Credentials and Security (AC: 4)
- [ ] Set up JWT credentials in n8n with secure signing secret
- [ ] Configure consistent JWT settings across all workflows (24h expiration)
- [ ] Set up PostgreSQL credentials for database access
- [ ] Configure proper webhook security and CORS settings
- [ ] Test JWT generation, verification, and refresh functionality
- [ ] Ensure all sensitive data (passwords) are properly handled and never logged

## Dev Notes

### Architecture Requirements
[Source: architecture/tech-stack.md]
- **Authentication Method:** Email/Password via n8n (JWT)
- **Database:** PostgreSQL 15 or 16 with proper user authentication tables
- **JWT Configuration:** Short-lived app JWTs with secure signing secrets
- **Password Security:** bcrypt or argon2 with salt (SHA256 for this implementation)

### API Endpoint Specifications
[Source: architecture/api-specification.md]
**Registration Endpoint:** `POST /webhook/register`
- Request: `{ email, password, name, confirm_password }`
- Response: `{ token, user: { id, email, created_at }, message }`

**Login Endpoint:** `POST /webhook/login`  
- Request: `{ email, password }`
- Response: `{ token, user: { id, email, created_at }, message }`

**Refresh Endpoint:** `POST /webhook/refresh`
- Headers: `Authorization: Bearer <jwt_token>`
- Response: `{ token, user: { id, email }, message }`

### Database Schema Requirements
[Source: architecture/high-level-architecture-email-password-auth.md]
**Users Table Structure:**
```sql
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v7(),
  email VARCHAR(255) UNIQUE NOT NULL,
  password_hash VARCHAR(255) NOT NULL,
  name VARCHAR(255) NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  last_login TIMESTAMP
);

CREATE INDEX idx_users_email ON users(email);
```

### N8N Workflow Development References
[Source: architecture/development-workflow.md]
- **Authentication Flow Example:** `docs/n8n_config_creation_instructions/authentication-login-register-logout-jwt-workflow-example.md`
- **JWT Middleware Example:** `docs/n8n_config_creation_instructions/authentication-jwt-middleware-workflow-example.md`
- **Database Operations:** `docs/n8n_config_creation_instructions/database-scheme-initialization-workflow-example.md`
- **HTTP and API Nodes:** `docs/n8n_config_creation_instructions/5-http-and-api-nodes.md`
- **Authentication Nodes:** `docs/n8n_config_creation_instructions/8-authentication-and-crypto-nodes.md`

### Security Implementation Details
[Source: architecture/high-level-architecture-email-password-auth.md]
- **Password Hashing:** Use n8n Crypto node with SHA256 algorithm
- **JWT Claims:** Include userId, email, expiresIn (24h)
- **Input Validation:** Email regex validation, password min 8 characters
- **Error Responses:** Proper HTTP status codes (400, 401, 500)
- **Database Security:** Parameterized queries to prevent SQL injection

### File Locations and Structure
[Source: stories/1.1.project-initialization.md and n8n examples]
```
n8n-config/
├── infrastructure/
│   ├── 01_db_init_seed.json (update with users table)
│   ├── 02_auth_api.json (combined register/login/logout - NEW)
│   ├── 03_jwt_middleware.json (JWT validation service - NEW)
│   └── 04_refresh_api.json (token refresh - NEW)
```

### Integration with Flutter Frontend
[Source: stories/1.5.simulated-user-login.md]
- Replace simulated login with real API calls to n8n endpoints
- Store JWT tokens securely in Flutter app
- Handle authentication state management in Provider
- Update login/register forms to make actual HTTP requests

### Testing Requirements
[Source: architecture/tech-stack.md]
- **Backend Testing:** Test n8n workflows with various input scenarios
- **Security Testing:** Validate password hashing, JWT security, input sanitization
- **Error Handling:** Test all error conditions and response codes
- **Integration Testing:** Verify Flutter app can successfully authenticate

### Environment Variables Required
[Source: architecture/development-workflow.md]
```
JWT_SECRET=<secure_random_string>
DB_HOST=<postgresql_host>
DB_PORT=5432
DB_NAME=<database_name>
DB_USER=<database_user>
DB_PASSWORD=<database_password>
```

## Change Log
**2025-09-18:** Story created to implement missing n8n authentication workflows based on architecture requirements and existing n8n examples.
