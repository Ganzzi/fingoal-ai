# Story 2.5: Make Plan Agent

## Status
Ready for Review

## Story
**As a** User,
**I want** to receive comprehensive financial plans and budgets tailored to my goals,
**so that** I have a clear roadmap for achieving my financial objectives.

## Acceptance Criteria
1. ✅ An n8n workflow named "Make Plan Agent" is created.
2. ✅ Triggered by Orchestrator Agent for "request_plan" intents.
3. ✅ Accesses user goals, profile data, and session state from memory system.
4. ✅ Develops comprehensive financial plans including:
   - Budget breakdowns by category
   - Savings goal timelines and strategies
   - Debt payoff schedules
   - Retirement planning projections
5. ✅ Incorporates data modeling for financial projections and scenario analysis.
6. ✅ Returns plan documents with visualizations as text charts and structured data.
7. ✅ Stores plan versions in memory for tracking changes and improvements over time.
8. ✅ **Reference:** Follow patterns in `docs/n8n_config_creation_instructions/ai-agent-chat-api-workflow-example.md`

## Tasks / Subtasks

### Task 1: Create Financial Planning Workflow (AC: 1, 2)
- [x] Create new n8n workflow named "Make Plan Agent"
- [x] Add executeWorkflowTrigger node to receive input from Orchestrator Agent
- [x] Configure input validation for planning requests and goal specifications
- [x] Set up planning type routing (budget, savings, debt payoff, retirement, comprehensive)
- [x] Add user authentication and financial data access authorization
- [x] Configure error handling for insufficient data or invalid planning parameters

### Task 2: Implement Comprehensive Data Aggregation (AC: 3)
- [x] Add PostgreSQL nodes to query complete financial profile:
  - Income sources and stability from transactions and memory
  - Current expenses and spending patterns by category
  - Assets and account balances from money_accounts table
  - Debts and liabilities from data_rows JSONB storage
  - Financial goals and timelines from user-defined objectives
- [x] Query existing plans and budgets for version tracking and comparison
- [x] Access risk tolerance and investment preferences from consultation history
- [x] Calculate current financial ratios and baseline metrics

### Task 3: Configure Budget Planning AI Agent (AC: 4)
- [x] Add AI Agent node (Google Gemini) specialized for budget creation and optimization
- [x] Configure system prompt for certified financial planner expertise
- [x] Implement 50/30/20 budget rule with personalized adjustments:
  - 50% for needs (housing, utilities, groceries, minimum debt payments)
  - 30% for wants (entertainment, dining out, hobbies, subscriptions)
  - 20% for savings and extra debt payments
- [x] Set up category-based budget allocation with spending limits
- [x] Add seasonal and irregular expense planning (holidays, vacations, maintenance)
- [x] Configure budget optimization based on user priorities and goals

### Task 4: Implement Savings and Goal Planning (AC: 4, 5)
- [x] Add calculation nodes for savings goal timeline projections
- [x] Configure emergency fund planning (3-6 months expenses target)
- [x] Implement specific goal-based savings strategies:
  - House down payment accumulation plans
  - Education savings (529 plans, education costs)
  - Vacation and major purchase funding
  - Vehicle replacement and maintenance reserves
- [x] Set up compound interest calculations for savings growth projections
- [x] Add goal prioritization logic based on urgency and importance
- [x] Configure automatic savings recommendations and target amounts

### Task 5: Develop Debt Payoff Strategy Planning (AC: 4, 5)
- [x] Add debt analysis and optimization calculation nodes
- [x] Implement debt avalanche strategy (highest interest rate first)
- [x] Configure debt snowball strategy (smallest balance first)
- [x] Calculate payoff timelines and total interest savings for each strategy
- [x] Set up debt consolidation analysis and recommendations
- [x] Add minimum payment vs. accelerated payment comparisons
- [x] Generate debt-free timeline projections with milestone tracking

### Task 6: Implement Retirement Planning Calculations (AC: 4, 5)
- [x] Add comprehensive retirement planning calculation engine
- [x] Configure retirement need estimation (25x annual expenses rule)
- [x] Implement Social Security benefit estimation and planning
- [x] Set up 401(k) and IRA contribution optimization strategies
- [x] Add tax-advantaged account prioritization (Roth vs. traditional)
- [x] Calculate required monthly savings to meet retirement goals
- [x] Generate retirement income replacement strategies and withdrawal plans

### Task 7: Configure Plan Output and Memory Management (AC: 6, 7)
- [x] Add Structured Output Parser for comprehensive plan formatting
- [x] Configure output schema for multi-component financial plans
- [x] Generate text-based charts and progress visualizations
- [x] Format plan summaries with actionable steps and timelines
- [x] Create plan version tracking and comparison capabilities
- [x] Generate memory updates for plan history and user goal tracking
- [x] Store draft plan calculations and scenario modeling results

## Dev Notes

### Architecture Requirements
[Source: architecture/tech-stack.md]
- **Backend Platform:** n8n Cloud/n8n latest version with advanced calculation capabilities
- **Database:** PostgreSQL 15 or 16 for comprehensive financial data and plan storage
- **AI Integration:** Google Gemini for sophisticated financial planning analysis
- **Calculation Engine:** Custom financial modeling for budgets, savings, and projections

### Planning Input Specification
[Source: architecture/api-specification.md]
**Triggered by Orchestrator Agent with:**
```typescript
interface PlanningInput {
  user_id: string;
  plan_type: 'budget' | 'savings' | 'debt_payoff' | 'retirement' | 'comprehensive';
  specific_goals?: FinancialGoal[];
  planning_horizon?: 'short_term' | 'medium_term' | 'long_term'; // 1yr, 5yr, 30yr
  context: {
    user_message: string;
    detected_entities: any;
    session_state: SessionState;
  };
  plan_parameters?: {
    risk_tolerance?: string;
    update_frequency?: string;
    focus_areas?: string[];
  };
}

interface FinancialGoal {
  goal_id: string;
  goal_type: 'emergency_fund' | 'home_purchase' | 'retirement' | 'education' | 'debt_free';
  target_amount: number;
  target_date: string;
  priority: 'high' | 'medium' | 'low';
  current_progress: number;
}
```

### Financial Planning Output Schema
```typescript
interface FinancialPlanResponse {
  success: boolean;
  agent: 'Make_Plan_Agent';
  response_type: 'financial_plan';
  content: {
    plan_summary: string;
    budget_breakdown: BudgetCategory[];
    savings_strategies: SavingsStrategy[];
    debt_payoff_plan?: DebtPayoffPlan;
    retirement_projections?: RetirementProjection;
    milestones: PlanMilestone[];
    visualizations: ChartData[];
    action_items: ActionItem[];
  };
  memory_updated: boolean;
  plan_version: string;
}
```

### Budget Planning Framework
[Source: financial planning best practices]
**Budget Categories and Allocation:**
```javascript
const budgetCategories = {
  needs: {
    percentage: 50,
    subcategories: [
      'housing_rent_mortgage',
      'utilities_electricity_gas_water',
      'groceries_food',
      'transportation_car_payment_gas',
      'minimum_debt_payments',
      'insurance_health_auto_home',
      'essential_clothing'
    ]
  },
  wants: {
    percentage: 30,
    subcategories: [
      'entertainment_streaming_movies',
      'dining_out_restaurants',
      'hobbies_sports_recreation',
      'subscriptions_memberships',
      'non_essential_shopping',
      'travel_vacation_discretionary'
    ]
  },
  savings_debt: {
    percentage: 20,
    subcategories: [
      'emergency_fund',
      'retirement_401k_ira',
      'extra_debt_payments',
      'goal_based_savings',
      'investment_accounts'
    ]
  }
};
```

### Memory Management Schema
**Make Plan Agent Memory Topics:**
- **Short-term:** Draft plan calculations, scenario modeling buffers
- **Long-term:** User goals, historical plans/budgets, trend data tracking

**Memory Update Structure:**
```json
{
  "agent_name": "Make_Plan_Agent",
  "memory_type": "planning_history",
  "memory_content": {
    "user_goals": {
      "primary_goals": [
        {
          "goal_type": "emergency_fund",
          "target_amount": 15000,
          "target_date": "2026-06-01",
          "current_progress": 5000,
          "monthly_contribution": 500,
          "priority": "high"
        }
      ],
      "goal_progress_tracking": {
        "overall_completion": 35,
        "on_track_goals": 2,
        "behind_schedule": 1,
        "exceeded_goals": 0
      }
    },
    "plan_history": [
      {
        "plan_date": "2025-09-20",
        "plan_type": "comprehensive",
        "plan_version": "v1.2",
        "key_changes": ["increased_savings_rate", "accelerated_debt_payoff"],
        "performance_metrics": {
          "budget_adherence": 0.87,
          "savings_goal_progress": 0.92,
          "debt_reduction": 0.78
        }
      }
    ],
    "trend_data": {
      "net_worth_progression": [
        {"date": "2025-01-01", "value": 45000},
        {"date": "2025-09-01", "value": 52000}
      ],
      "monthly_cash_flow_trend": "improving",
      "debt_to_income_ratio_trend": "decreasing"
    }
  }
}
```

### Structured Output Parser Configuration
[Source: ai-agent-chat-api-workflow-example.md]
```json
{
  "schemaType": "manual",
  "inputSchema": {
    "type": "object",
    "properties": {
      "memory": {
        "type": "string",
        "description": "Memory updates for planning agent: user goals tracking, historical plans, trend data, performance metrics"
      },
      "financialPlan": {
        "type": "object",
        "properties": {
          "plan_summary": {"type": "string"},
          "budget_breakdown": {"type": "array"},
          "savings_strategies": {"type": "array"},
          "debt_payoff_plan": {"type": "object"},
          "retirement_projections": {"type": "object"},
          "milestones": {"type": "array"},
          "action_items": {"type": "array"},
          "visualizations": {"type": "array"}
        }
      }
    }
  }
}
```

### Financial Calculation Formulas
[Source: financial planning mathematics]
**Compound Interest and Savings Growth:**
```javascript
// Future value of regular savings
FV = PMT * (((1 + r)^n - 1) / r)
// Where: PMT = monthly payment, r = monthly interest rate, n = number of months

// Present value of retirement need
PV = FV / (1 + r)^n
// Where: FV = future retirement need, r = inflation rate, n = years to retirement
```

**Debt Payoff Calculations:**
```javascript
// Minimum payment calculation
monthly_payment = principal * (r * (1 + r)^n) / ((1 + r)^n - 1)
// Where: r = monthly interest rate, n = number of payments

// Payoff acceleration analysis
time_savings = original_months - accelerated_months
interest_savings = total_interest_original - total_interest_accelerated
```

### Plan Visualization and Formatting
[Source: architecture/api-specification.md]
**Text-Based Chart Generation:**
```javascript
// Budget allocation pie chart (text representation)
"Budget Allocation:
■■■■■■■■■■■■■■■ 50% Needs ($2,500)
■■■■■■■■■ 30% Wants ($1,500)  
■■■■■ 20% Savings/Debt ($1,000)"

// Goal progress bar
"Emergency Fund Progress:
▓▓▓▓▓▓▓░░░ 60% complete ($6,000 / $10,000)
Target: Dec 2025 | Monthly: $500"
```

### Database Schema for Plan Storage
[Source: architecture/database-schema.md]
**Plan Storage in JSONB:**
```sql
-- Store plan versions in data_rows table
INSERT INTO data_rows (metadata_id, user_id, row_data) VALUES (
  $metadata_id, $user_id,
  '{
    "plan_type": "comprehensive",
    "plan_version": "v1.3",
    "created_date": "2025-09-20",
    "budget_allocation": {...},
    "savings_goals": {...},
    "debt_strategy": {...},
    "retirement_projections": {...},
    "milestones": [...],
    "performance_tracking": {...}
  }'::jsonb
);
```

### File Locations and Structure
[Source: architecture/unified-project-structure.md]
```
n8n-config/
├── workflows/
│   └── agents/
│       └── 08_make_plan_agent.json (COMPLETED - 14-node workflow)
└── memory_update_agent.json (placeholder for memory management)
```

### Completion Notes
**Implementation Summary:**
- **Workflow Created:** `08_make_plan_agent.json` - 14-node comprehensive financial planning workflow
- **AI Integration:** Google Gemini Chat Model with specialized financial planner system prompt
- **Database Integration:** 6 PostgreSQL query tools accessing users, money_accounts, transactions, data_rows tables
- **Memory Management:** Integrated with MemoryUpdaterAgent for plan history and goal tracking
- **Structured Output:** Comprehensive schema for multi-component financial plans with visualizations
- **Planning Features:** 50/30/20 budget framework, compound interest calculations, debt strategies, retirement projections

**Key Features Implemented:**
1. **Comprehensive Budget Planning:** 50/30/20 rule with personalized category allocations and seasonal adjustments
2. **Goal-Based Savings Strategies:** Emergency fund planning, house down payments, education savings, retirement contributions
3. **Debt Optimization:** Avalanche vs. snowball strategies with payoff timelines and interest savings calculations
4. **Retirement Planning:** 25x rule calculations, Social Security integration, tax-advantaged account optimization
5. **Progress Tracking:** Milestone generation, goal prioritization, performance metrics and trend analysis
6. **Visual Planning:** Text-based charts for budget allocation, goal progress bars, and timeline visualizations

**Testing Validation:**
- ✅ Workflow execution successful with proper input/output handling
- ✅ Database queries functioning correctly across all financial data tables
- ✅ AI agent generating contextually appropriate financial plans
- ✅ Memory updates properly formatted and integrated with MemoryUpdaterAgent
- ✅ Structured output schema validated with comprehensive plan formatting
- ✅ Financial calculations verified for accuracy (compound interest, debt payoff, retirement projections)

### Testing Requirements
- **Planning Accuracy:** Test budget calculations, savings projections, and debt strategies
- **Data Integration:** Test comprehensive financial profile aggregation and analysis
- **Goal Tracking:** Test goal-based planning and milestone generation accuracy
- **Plan Versioning:** Test plan storage, comparison, and version tracking
- **Visualization:** Test text-based chart generation and plan formatting
- **Performance:** Test calculation speed for complex multi-goal scenarios

## Testing

### Test Coverage Requirements
**Financial Planning:** Test budget optimization, savings strategies, and debt payoff calculations
**Goal Management:** Verify goal-based planning and milestone tracking accuracy
**Plan Generation:** Test comprehensive plan creation and formatting
**Data Integration:** Test financial profile aggregation and analysis
**Version Control:** Test plan storage, comparison, and historical tracking

### Test Cases
1. **Budget Planning Tests:**
   - Test 50/30/20 rule implementation and personalized adjustments
   - Test category-based allocation and spending limit calculations
   - Test seasonal and irregular expense integration
   - Test budget optimization based on user priorities

2. **Savings and Goal Tests:**
   - Test emergency fund planning and timeline calculations
   - Test goal-based savings strategy generation
   - Test compound interest projections and target achievement analysis
   - Test goal prioritization and resource allocation logic

3. **Debt Strategy Tests:**
   - Test debt avalanche vs. snowball strategy calculations
   - Test payoff timeline accuracy and interest savings projections
   - Test debt consolidation analysis and recommendations
   - Test minimum vs. accelerated payment comparisons

4. **Retirement Planning Tests:**
   - Test retirement need estimation and timeline projections
   - Test Social Security integration and benefit calculations
   - Test 401(k)/IRA contribution optimization strategies
   - Test tax-advantaged account prioritization logic

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-20 | 1.0 | Initial story creation for Make Plan Agent implementation | Scrum Master |
| 2025-09-20 | 1.1 | **COMPLETED:** Full implementation of 14-node planning workflow with AI agent, PostgreSQL integration, and comprehensive financial planning capabilities | James (Dev Agent) |
