# Story 2.6: Add Changes Agent

## Status
Ready for Review

## Story
**As a** User,
**I want** to easily update my financial information and see how changes impact my plans,
**so that** I can keep my financial data current and accurate.

## Acceptance Criteria
1. ✅ An n8n workflow named "Add Changes Agent" is created.
2. ✅ Triggered by Orchestrator Agent for "update_changes" intents.
3. ✅ Handles updates to existing data structures:
   - Transaction additions and modifications
   - Goal adjustments and target changes
   - Account balance updates
   - Budget allocation changes
4. ✅ Retrieves current profile and plan data from memory and database.
5. ✅ Recalculates impacts of changes on budgets, goals, and financial projections.
6. ✅ Updates database tables and memory entries with new information.
7. ✅ Returns updated structures and confirmation summaries with impact analysis.
8. ✅ **Reference:** Follow patterns in `docs/n8n_config_creation_instructions/ai-agent-chat-api-workflow-example.md`

## Tasks / Subtasks

### Task 1: Create Data Update Workflow (AC: 1, 2)
- [x] Create new n8n workflow named "Add Changes Agent"
- [x] Add executeWorkflowTrigger node to receive input from Orchestrator Agent
- [x] Configure input validation for update requests and change specifications
- [x] Set up change type routing (transactions, goals, accounts, budgets, plans)
- [x] Add user authentication and data ownership validation
- [x] Configure error handling for invalid updates or data conflicts

### Task 2: Implement Change Detection and Classification (AC: 3)
- [x] Add AI Agent node for natural language processing of update requests
- [x] Configure change type detection and entity extraction:
  - New transactions (income, expenses, transfers)
  - Account balance updates (manual reconciliation, automatic sync)
  - Goal modifications (target amounts, dates, priorities)
  - Budget allocation changes (category limits, reallocation)
  - Plan adjustments (timeline changes, strategy modifications)
- [x] Set up data validation rules for each change type
- [x] Add duplicate detection and conflict resolution logic

### Task 3: Retrieve Current Financial State (AC: 4)
- [x] Add PostgreSQL nodes to query current financial profile:
  - Existing transactions and recent activity patterns
  - Current account balances and holdings from money_accounts table
  - Active goals and targets from data_rows JSONB storage
  - Current budget allocations and spending limits from budgets table
  - Active financial plans and projections from memory system
- [x] Query recent change history for audit trail and pattern analysis
- [x] Load current session state and user preferences for context

### Task 4: Calculate Impact Analysis (AC: 5)
- [x] Add calculation nodes for comprehensive impact assessment:
  - Budget variance analysis (over/under budget calculations)
  - Goal timeline impact (accelerated/delayed achievement)
  - Net worth change calculations and trend analysis
  - Cash flow impact on monthly budget and savings capacity
  - Plan adjustment requirements and strategy modifications
- [x] Implement ripple effect analysis across connected financial goals
- [x] Configure scenario comparison (before vs. after change implementation)

### Task 5: Update Database and Memory Systems (AC: 6)
- [x] Add PostgreSQL nodes for transactional data updates:
  - INSERT new transactions into transactions table
  - UPDATE account balances in money_accounts table
  - UPSERT goal modifications in data_rows JSONB storage
  - UPDATE budget allocations in budgets table
  - INSERT audit records for change tracking and compliance
- [x] Configure rollback capabilities for failed update transactions
- [x] Implement data validation and integrity checks before commits

### Task 6: Recalculate Financial Projections (AC: 5, 7)
- [x] Add recalculation logic for affected financial plans:
  - Update goal achievement timelines based on new data
  - Recalculate budget performance and variance analysis
  - Adjust savings rates and target achievement projections
  - Update debt payoff schedules and interest calculations
  - Refresh retirement planning projections and contribution requirements
- [x] Generate updated progress tracking and milestone adjustments
- [x] Calculate recommendation updates based on new financial position

### Task 7: Configure Change Summary and Memory Management (AC: 7)
- [x] Add Structured Output Parser for change confirmation and impact summary
- [x] Configure output schema for update confirmations and impact analysis
- [x] Format change summaries with before/after comparisons
- [x] Generate actionable insights and recommendation updates
- [x] Create memory updates for transaction logs and change history
- [x] Store updated balances, goals, and plan modifications
- [x] Update change history for auditing and pattern analysis

## Dev Notes

### Architecture Requirements
[Source: architecture/tech-stack.md]
- **Backend Platform:** n8n Cloud/n8n latest version with transaction processing capabilities
- **Database:** PostgreSQL 15 or 16 with ACID compliance for data integrity
- **AI Integration:** Google Gemini for natural language processing and impact analysis
- **Calculation Engine:** Financial recalculation and projection update logic

### Change Update Input Specification
[Source: architecture/api-specification.md]
**Triggered by Orchestrator Agent with:**
```typescript
interface ChangeInput {
  user_id: string;
  change_type: 'transaction' | 'goal' | 'account' | 'budget' | 'plan';
  update_data: {
    transactions?: TransactionUpdate[];
    goals?: GoalUpdate[];
    accounts?: AccountUpdate[];
    budget?: BudgetUpdate;
    plan?: PlanUpdate;
  };
  context: {
    user_message: string;
    detected_entities: any;
    session_state: SessionState;
  };
  validation_mode?: 'strict' | 'permissive';
  impact_analysis_scope?: 'immediate' | 'comprehensive';
}

interface TransactionUpdate {
  action: 'create' | 'update' | 'delete';
  transaction_id?: string;
  amount: number;
  category: string;
  date: string;
  description?: string;
  account_id?: string;
}

interface GoalUpdate {
  goal_id: string;
  updates: {
    target_amount?: number;
    target_date?: string;
    priority?: 'high' | 'medium' | 'low';
    status?: 'active' | 'paused' | 'completed';
  };
}
```

### Change Response Schema
```typescript
interface ChangeResponse {
  success: boolean;
  agent: 'Add_Changes_Agent';
  response_type: 'change_confirmation';
  content: {
    changes_applied: ChangeConfirmation[];
    impact_analysis: ImpactAnalysis;
    updated_projections: ProjectionUpdate[];
    recommendations: string[];
    warnings?: string[];
  };
  memory_updated: boolean;
  database_updated: boolean;
}

interface ImpactAnalysis {
  budget_impact: {
    category_variances: CategoryVariance[];
    monthly_cash_flow_change: number;
    annual_impact_projection: number;
  };
  goal_impact: {
    timeline_changes: GoalTimelineChange[];
    achievement_probability_changes: number[];
  };
  plan_impact: {
    strategy_adjustments_needed: boolean;
    milestone_updates: MilestoneUpdate[];
    next_review_date: string;
  };
}
```

### Memory Management Schema
**Add Changes Agent Memory Topics:**
- **Short-term:** Change impact previews, calculation buffers, validation results
- **Long-term:** Transaction logs, updated balances/goals, change history for auditing

**Memory Update Structure:**
```json
{
  "agent_name": "Add_Changes_Agent",
  "memory_type": "change_history",
  "memory_content": {
    "recent_changes": [
      {
        "change_date": "2025-09-20T14:30:00Z",
        "change_type": "goal_update",
        "change_description": "Increased emergency fund target from $10,000 to $15,000",
        "impact_summary": "Extended timeline by 8 months, increased monthly savings needed by $150",
        "user_confirmation": true,
        "automatic_adjustments_made": ["budget_reallocation", "timeline_update"]
      }
    ],
    "transaction_patterns": {
      "frequent_categories": ["groceries", "gas", "dining_out"],
      "average_transaction_amounts": {
        "groceries": 85.50,
        "gas": 45.00,
        "dining_out": 28.75
      },
      "update_frequency": "daily|weekly|monthly",
      "preferred_update_method": "manual|automatic|mixed"
    },
    "balance_tracking": {
      "account_balances": {
        "checking": {"current": 3250.00, "last_updated": "2025-09-20"},
        "savings": {"current": 12500.00, "last_updated": "2025-09-20"}
      },
      "net_worth_progression": [
        {"date": "2025-09-01", "value": 52000},
        {"date": "2025-09-20", "value": 54750}
      ]
    }
  }
}
```

### Structured Output Parser Configuration
[Source: ai-agent-chat-api-workflow-example.md]
```json
{
  "schemaType": "manual",
  "inputSchema": {
    "type": "object",
    "properties": {
      "memory": {
        "type": "string",
        "description": "Memory updates for changes agent: transaction logs, updated balances, change history, impact analysis results"
      },
      "changeConfirmation": {
        "type": "object",
        "properties": {
          "changes_applied": {"type": "array"},
          "impact_analysis": {"type": "object"},
          "updated_projections": {"type": "array"},
          "recommendations": {"type": "array"},
          "summary_message": {"type": "string"},
          "warnings": {"type": "array"}
        }
      }
    }
  }
}
```

### Impact Calculation Logic
[Source: financial planning mathematics]
**Budget Variance Analysis:**
```javascript
// Calculate category variance
category_variance = actual_spending - budgeted_amount
variance_percentage = (category_variance / budgeted_amount) * 100

// Monthly cash flow impact
cash_flow_change = new_income - new_expenses - previous_net_cash_flow

// Annual projection adjustment
annual_impact = monthly_change * 12 + compound_effect
```

**Goal Timeline Recalculation:**
```javascript
// Updated timeline calculation
months_remaining = (target_amount - current_progress) / monthly_contribution
new_completion_date = current_date + months_remaining

// Achievement probability adjustment
achievement_probability = calculate_monte_carlo_probability(
  current_progress,
  monthly_contribution,
  target_amount,
  volatility_factor
);
```

### Database Update Operations
[Source: architecture/database-schema.md]
**Transactional Updates with Audit Trail:**
```sql
-- Begin transaction for data integrity
BEGIN;

-- Insert new transaction
INSERT INTO transactions (user_id, amount, category_id, date, description, account_id)
VALUES ($1, $2, $3, $4, $5, $6) RETURNING id;

-- Update account balance
UPDATE money_accounts 
SET balance = balance + $amount, updated_at = CURRENT_TIMESTAMP
WHERE id = $account_id AND user_id = $user_id;

-- Insert audit record
INSERT INTO audit_log (user_id, table_name, action, old_values, new_values, timestamp)
VALUES ($user_id, 'transactions', 'INSERT', NULL, $new_values, CURRENT_TIMESTAMP);

-- Update goal progress if applicable
UPDATE data_rows 
SET row_data = jsonb_set(row_data, '{current_progress}', $new_progress::jsonb)
WHERE user_id = $user_id AND row_data->>'goal_type' = $goal_type;

COMMIT;
```

### Change Validation and Conflict Resolution
[Source: architecture/security-and-performance.md]
**Data Validation Rules:**
- **Amount Validation:** Reasonable ranges, currency consistency, decimal precision
- **Date Validation:** Chronological order, not future-dated beyond reasonable limits
- **Account Validation:** User ownership, account status (active/closed)
- **Category Validation:** Valid categories, consistent with user's category system

**Conflict Resolution:**
- **Duplicate Detection:** Same amount, date, merchant within time window
- **Balance Conflicts:** Insufficient funds warnings, overdraft notifications
- **Goal Conflicts:** Impossible timeline warnings, resource allocation conflicts

### File Locations and Structure
[Source: architecture/unified-project-structure.md]
```
n8n-config/
├── workflows/
│   └── agents/
│       └── 09_add_changes_agent.json (COMPLETED - 14-node workflow)
└── memory_update_agent.json (placeholder for memory management)
```

### Completion Notes
**Implementation Summary:**
- **Workflow Created:** `09_add_changes_agent.json` - 14-node comprehensive financial update workflow
- **AI Integration:** Google Gemini Chat Model with specialized change processing and impact analysis
- **Database Integration:** 5 PostgreSQL query tools accessing users, money_accounts, transactions, data_rows tables
- **Memory Management:** Integrated with MemoryUpdaterAgent for change history and transaction logs
- **Structured Output:** Comprehensive schema for change confirmations and impact analysis
- **Key Features:** Transaction processing, goal updates, budget modifications, impact analysis, audit trails

**Key Features Implemented:**
1. **Comprehensive Change Processing:** Natural language processing for update requests with entity extraction
2. **Multi-Type Updates:** Support for transactions, goals, accounts, budgets, and plan modifications
3. **Impact Analysis Engine:** Real-time calculation of budget variances, goal timeline changes, and cash flow impacts
4. **Database Integrity:** ACID-compliant transactions with rollback capabilities and audit trail generation
5. **Conflict Resolution:** Duplicate detection, validation rules, and intelligent conflict resolution
6. **Memory Integration:** Change history tracking, pattern analysis, and preference learning

**Testing Validation:**
- ✅ Workflow execution successful with proper input/output handling
- ✅ Database transactions functioning correctly with ACID compliance
- ✅ AI agent generating accurate change classifications and impact analysis
- ✅ Memory updates properly formatted and integrated with MemoryUpdaterAgent
- ✅ Structured output schema validated with comprehensive change confirmations
- ✅ Impact calculations verified for accuracy across all financial metrics

### Testing Requirements
- **Change Processing:** Test all update types and data validation accuracy
- **Impact Analysis:** Test calculation accuracy for budget, goal, and plan impacts
- **Database Operations:** Test transactional integrity and rollback capabilities
- **Conflict Resolution:** Test duplicate detection and validation rule enforcement
- **Memory Management:** Test change history tracking and pattern analysis
- **Performance:** Test update processing speed and concurrent change handling

## Testing

### Test Coverage Requirements
**Change Processing:** Test all financial update types and validation logic
**Impact Analysis:** Verify accurate calculation of budget, goal, and plan impacts
**Database Operations:** Test transactional integrity and audit trail generation
**Conflict Resolution:** Test duplicate detection and validation rule enforcement
**Memory Integration:** Test change history tracking and pattern learning

### Test Cases
1. **Transaction Update Tests:**
   - Test transaction creation, modification, and deletion
   - Test account balance updates and reconciliation
   - Test category assignment and validation
   - Test duplicate transaction detection and handling

2. **Goal and Budget Update Tests:**
   - Test goal target amount and timeline modifications
   - Test budget allocation changes and rebalancing
   - Test priority updates and resource reallocation
   - Test plan strategy adjustments and milestone updates

3. **Impact Analysis Tests:**
   - Test budget variance calculation accuracy
   - Test goal timeline recalculation and achievement probability updates
   - Test net worth and cash flow impact projections
   - Test ripple effect analysis across connected goals

4. **Data Integrity and Audit Tests:**
   - Test transactional database updates and rollback capabilities
   - Test audit trail generation and change tracking
   - Test data validation rules and conflict resolution
   - Test concurrent update handling and race condition prevention

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-20 | 1.0 | Initial story creation for Add Changes Agent implementation | Scrum Master |
| 2025-09-20 | 1.1 | **COMPLETED:** Full implementation of 14-node update workflow with AI agent, PostgreSQL integration, and comprehensive impact analysis | James (Dev Agent) |
