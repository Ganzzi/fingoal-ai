# Story 2.8: Agent Workflow Coordination

## Status
Draft

## Story
**As a** System,
**I want** to ensure seamless coordination between all agents with proper session management,
**so that** users receive consistent and contextual responses across all interactions.

## Acceptance Criteria
1. A standardized session schema in the `memories` table:
   - session_id, user_id, session_type, session_state, progress_percentage, created_at, updated_at
2. All agents consistently read from and write to the memories table for session continuity.
3. Intent prioritization system for mixed-intent messages (primary intent processed, secondary noted).
4. Error handling and fallback mechanisms for agent communication failures.
5. Session timeout and cleanup for inactive conversations.
6. Cross-agent data sharing through structured memory entries and database access.

## Tasks / Subtasks

### Task 1: Create Agent Coordination Infrastructure (AC: 1, 6)
- [ ] Create specialized n8n workflow named "Agent Coordination Manager"
- [ ] Add executeWorkflowTrigger node for system-level coordination requests
- [ ] Configure standardized memory table schema for cross-agent communication
- [ ] Set up centralized session state management with consistent data structures
- [ ] Add database initialization for coordination tables and indexes
- [ ] Configure UUID generation and session identifier management

### Task 2: Implement Memory Management Agent Placeholder (AC: 2, 6)
- [ ] Create dedicated n8n workflow named "Memory Management Agent"
- [ ] Add executeWorkflowTrigger to receive memory update requests from all agents
- [ ] Configure memory update processing with structured data validation
- [ ] Set up memory categorization and storage for different agent types:
  - Intent/Session: interaction patterns, session history
  - Orchestrator: communication preferences, compliance logs  
  - Data Collection: financial profile, completeness tracking
  - Consultation: risk tolerance, advisory history
  - Planning: user goals, plan versions, trend data
  - Changes: transaction logs, change history
  - Education: progress tracking, knowledge mastery
- [ ] Add memory retrieval and query capabilities for agent requests
- [ ] Configure memory cleanup and archival for old sessions

### Task 3: Standardize Session State Schema (AC: 1, 2)
- [ ] Define comprehensive session state schema in memories table
- [ ] Add PostgreSQL table creation with proper indexes and constraints:
  ```sql
  CREATE TABLE IF NOT EXISTS session_coordination (
    session_id UUID PRIMARY KEY DEFAULT uuid_generate_v7(),
    user_id UUID NOT NULL,
    session_type VARCHAR(50) DEFAULT 'multi_agent_chat',
    current_agent VARCHAR(100),
    agent_sequence JSONB,
    session_state JSONB,
    progress_percentage INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    expires_at TIMESTAMP DEFAULT (CURRENT_TIMESTAMP + INTERVAL '24 hours'),
    FOREIGN KEY (user_id) REFERENCES users(id)
  );
  ```
- [ ] Configure session state validation and consistency checks
- [ ] Add session state versioning for audit and rollback capabilities

### Task 4: Implement Intent Prioritization System (AC: 3)
- [ ] Add AI Agent node for mixed-intent analysis and prioritization
- [ ] Configure intent ranking algorithm based on:
  - User urgency indicators (time-sensitive requests)
  - Financial priority (emergency vs. planning vs. education)
  - Session context (current active process continuation)
  - Agent capacity and availability status
- [ ] Set up intent queuing and sequential processing for complex requests
- [ ] Add secondary intent tracking for follow-up processing
- [ ] Configure intent conflict resolution and user clarification requests

### Task 5: Create Agent Communication Error Handling (AC: 4)
- [ ] Add comprehensive error handling for inter-agent communication failures:
  - Agent timeout detection and retry mechanisms
  - Agent unavailability fallback routing
  - Data corruption detection and recovery
  - Partial response compilation and user notification
- [ ] Configure circuit breaker patterns for failed agent dependencies
- [ ] Set up graceful degradation when specialized agents are offline
- [ ] Add error logging and monitoring for system reliability tracking
- [ ] Implement fallback response generation using basic rule-based logic

### Task 6: Implement Session Timeout and Cleanup (AC: 5)
- [ ] Add automated session timeout monitoring with configurable time limits:
  - Active conversation timeout: 2 hours of inactivity
  - Session data retention: 30 days for completed sessions
  - Memory archival: 1 year for user interaction patterns
- [ ] Configure session cleanup workflows triggered by scheduled intervals
- [ ] Add session state preservation for important long-term processes
- [ ] Set up user notification for session expiration and data cleanup
- [ ] Implement session recovery and continuation capabilities

### Task 7: Configure Cross-Agent Data Sharing Standards (AC: 2, 6)
- [ ] Establish standardized data sharing protocols between all agents:
  - Common data formats and schemas for financial information
  - Consistent user profile access patterns and permissions
  - Standardized memory update and retrieval interfaces
  - Unified session state reading and writing conventions
- [ ] Add data validation and integrity checks for shared information
- [ ] Configure access control and data privacy protection between agents
- [ ] Set up performance monitoring for cross-agent data access patterns
- [ ] Add documentation and examples for agent integration standards

## Dev Notes

### Architecture Requirements
[Source: architecture/tech-stack.md]
- **Backend Platform:** n8n Cloud/n8n latest version for workflow orchestration and coordination
- **Database:** PostgreSQL 15 or 16 for session management and cross-agent data sharing
- **Session Management:** Centralized session state with distributed agent access
- **Error Handling:** Comprehensive fault tolerance and graceful degradation

### Session Coordination Schema
[Source: architecture/database-schema.md and multi-agent system design]
**Standardized Session State Structure:**
```typescript
interface SessionCoordinationState {
  session_id: string;
  user_id: string;
  session_type: 'multi_agent_chat' | 'planning_session' | 'consultation' | 'education';
  current_agent: string;
  agent_sequence: AgentExecution[];
  session_state: {
    active_process: string | null;
    progress_percentage: number;
    conversation_context: ConversationContext;
    pending_actions: PendingAction[];
    agent_outputs: {[agent_name: string]: any};
    user_preferences: UserPreferences;
  };
  coordination_metadata: {
    session_priority: 'low' | 'normal' | 'high' | 'urgent';
    complexity_score: number;
    estimated_completion_time: number;
    resource_requirements: string[];
  };
}

interface AgentExecution {
  agent_name: string;
  execution_order: number;
  status: 'pending' | 'executing' | 'completed' | 'failed';
  start_time?: string;
  completion_time?: string;
  output_summary?: string;
  next_agent?: string;
}
```

### Memory Management Standards
**Cross-Agent Memory Categories:**
```json
{
  "memory_categories": {
    "session_data": {
      "retention_period": "24_hours",
      "access_level": "all_agents",
      "content": "current_conversation_context"
    },
    "user_profile": {
      "retention_period": "permanent",
      "access_level": "authorized_agents",
      "content": "financial_profile_and_preferences"
    },
    "interaction_patterns": {
      "retention_period": "1_year", 
      "access_level": "analytics_agents",
      "content": "usage_patterns_and_learning"
    },
    "agent_outputs": {
      "retention_period": "30_days",
      "access_level": "coordination_manager",
      "content": "agent_results_and_recommendations"
    }
  }
}
```

### Intent Prioritization Algorithm
[Source: multi-agent system coordination theory]
**Intent Priority Scoring:**
```javascript
function calculateIntentPriority(intent, userContext, sessionState) {
  let priorityScore = 0;
  
  // Base intent priorities
  const intentWeights = {
    'emergency_financial': 100,
    'urgent_changes': 80,
    'request_consultation': 60,
    'request_plan': 50,
    'provide_info': 40,
    'ask_question': 30,
    'general_inquiry': 20
  };
  
  // Context modifiers
  const contextModifiers = {
    'session_in_progress': 20,
    'incomplete_critical_process': 30,
    'user_expressed_urgency': 25,
    'time_sensitive_deadline': 15
  };
  
  priorityScore = intentWeights[intent.type] || 20;
  
  // Apply context modifiers
  Object.keys(contextModifiers).forEach(modifier => {
    if (sessionState.context_flags?.includes(modifier)) {
      priorityScore += contextModifiers[modifier];
    }
  });
  
  return Math.min(priorityScore, 100); // Cap at 100
}
```

### Error Handling and Fallback Patterns
[Source: architecture/security-and-performance.md]
**Agent Communication Resilience:**
```javascript
const agentFallbackStrategies = {
  'Intent_Session_Agent': {
    fallback: 'keyword_based_intent_detection',
    timeout: 10000,
    retry_attempts: 3
  },
  'Orchestrator_Agent': {
    fallback: 'direct_agent_routing',
    timeout: 15000,
    retry_attempts: 2
  },
  'Collect_Create_Data_Agent': {
    fallback: 'manual_data_entry_prompt',
    timeout: 30000,
    retry_attempts: 3
  },
  'Consult_Customer_Agent': {
    fallback: 'generic_financial_advice_disclaimer',
    timeout: 45000,
    retry_attempts: 2
  },
  'Make_Plan_Agent': {
    fallback: 'basic_budget_template',
    timeout: 60000,
    retry_attempts: 2
  },
  'Add_Changes_Agent': {
    fallback: 'change_confirmation_without_analysis',
    timeout: 20000,
    retry_attempts: 3
  },
  'Educate_Customer_Agent': {
    fallback: 'static_educational_content',
    timeout: 25000,
    retry_attempts: 2
  }
};
```

### Session Timeout and Cleanup Configuration
**Automated Session Management:**
```sql
-- Session cleanup query (run every hour)
DELETE FROM session_coordination 
WHERE expires_at < CURRENT_TIMESTAMP 
  AND session_state->>'active_process' IS NULL;

-- Archive completed sessions  
INSERT INTO session_archive 
SELECT * FROM session_coordination 
WHERE created_at < CURRENT_TIMESTAMP - INTERVAL '30 days'
  AND session_state->>'status' = 'completed';

-- Update session expiration for active processes
UPDATE session_coordination 
SET expires_at = CURRENT_TIMESTAMP + INTERVAL '4 hours'
WHERE session_state->>'active_process' IS NOT NULL
  AND updated_at > CURRENT_TIMESTAMP - INTERVAL '30 minutes';
```

### Cross-Agent Data Sharing Standards
[Source: architecture/unified-project-structure.md]
**Standardized Agent Integration Pattern:**
```typescript
interface AgentCommunicationProtocol {
  request_format: {
    agent_name: string;
    request_id: string;
    user_id: string;
    session_id: string;
    input_data: any;
    context: SessionContext;
    priority: number;
    timeout_ms: number;
  };
  response_format: {
    agent_name: string;
    request_id: string;
    success: boolean;
    output_data: any;
    memory_updates: MemoryUpdate[];
    next_agent_suggestions?: string[];
    error_details?: ErrorDetails;
    execution_time_ms: number;
  };
}
```

### Coordination Workflow File Structure
[Source: architecture/unified-project-structure.md]
```
n8n-config/
├── epic2-multi-agent/
│   ├── 11_agent_coordination_manager.json (THIS STORY - NEW)
│   ├── 12_memory_management_agent.json (THIS STORY - NEW)
│   └── 13_session_cleanup_scheduler.json (THIS STORY - NEW)
```

### Memory Update Placeholder Implementation
**Memory Management Agent Workflow Structure:**
```json
{
  "parameters": {
    "operation": "receive_memory_update",
    "memory_categories": [
      "session_context",
      "user_profile_updates", 
      "interaction_patterns",
      "agent_performance_metrics"
    ]
  },
  "validation_rules": {
    "required_fields": ["user_id", "agent_name", "memory_type", "memory_content"],
    "max_content_size": "1MB",
    "retention_policies": "automatic_based_on_memory_type"
  },
  "processing_logic": "PLACEHOLDER - To be implemented in future sprint",
  "storage_strategy": {
    "short_term": "redis_cache_24_hours",
    "long_term": "postgresql_jsonb_storage",
    "archival": "compressed_storage_1_year_retention"
  }
}
```

### Testing Requirements
- **Session Management:** Test session creation, state updates, and cleanup across all agents
- **Intent Prioritization:** Test mixed-intent scenarios and priority-based routing
- **Error Handling:** Test agent failure scenarios and fallback mechanism effectiveness  
- **Memory Coordination:** Test cross-agent data sharing and consistency
- **Performance:** Test system-wide coordination performance and scalability
- **Timeout Management:** Test session expiration and recovery capabilities

## Testing

### Test Coverage Requirements
**Session Coordination:** Test session state management and cross-agent consistency
**Intent Processing:** Verify mixed-intent prioritization and routing accuracy
**Error Resilience:** Test agent failure scenarios and fallback effectiveness
**Memory Management:** Test cross-agent data sharing and memory consistency
**Performance Monitoring:** Test system coordination performance and bottlenecks

### Test Cases
1. **Session Management Tests:**
   - Test session creation and state initialization across agents
   - Test session state updates and consistency maintenance
   - Test session timeout and cleanup automation
   - Test session recovery and continuation after interruptions

2. **Intent Prioritization and Routing Tests:**
   - Test mixed-intent message analysis and priority scoring
   - Test intent queuing and sequential processing
   - Test conflict resolution and user clarification requests
   - Test priority-based agent routing and resource allocation

3. **Agent Communication and Error Handling Tests:**
   - Test inter-agent communication protocols and data sharing
   - Test agent failure detection and fallback activation
   - Test graceful degradation and partial response compilation
   - Test error logging and system reliability monitoring

4. **Memory and Data Coordination Tests:**
   - Test standardized memory update and retrieval across agents
   - Test cross-agent data consistency and integrity validation
   - Test memory cleanup and archival automation
   - Test access control and data privacy protection

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-20 | 1.0 | Initial story creation for Agent Workflow Coordination implementation | Scrum Master |
