# Story 1.3: Backend Router Agent with Language Handling

## Status
Done

## Story
**As a** Flutter App,
**I want** to send a request with a language identifier to a central n8n endpoint,
**so that** the backend knows which language to respond in.

## Acceptance Criteria
1. An n8n workflow named "Router Agent" is created with a `POST` webhook trigger at a defined path (e.g., `/webhook/router`).
2. The router expects a `language` field (e.g., "en" or "vi") in the incoming JSON payload.
3. The router's placeholder logic is updated: it receives the payload, logs the detected language, and returns a simple `{"status": "received", "language": "[detected_language]"}` JSON response.
4. The webhook URL is documented.
5. **Reference:** Follow the n8n workflow patterns documented in `docs/n8n_config_creation_instructions/ai-agent-chat-api-workflow-example.md`

## Tasks / Subtasks
- [x] Task 1: Create n8n workflow file structure (AC: 1)
  - [x] Create `04_router_ai.json` file in `/n8n-config/agents/` directory
  - [x] Set up workflow metadata with proper name "Router Agent"
  - [x] Configure POST webhook trigger at `/webhook/router` path

- [x] Task 2: Implement webhook request handling (AC: 2)
  - [x] Add webhook node with POST method and `/webhook/router` path
  - [x] Configure request parsing to extract JSON payload
  - [x] Validate incoming request structure and required fields
  - [x] Extract language field from request payload

- [x] Task 3: Implement language detection and logging (AC: 2, 3)
  - [x] Add logic to detect and validate language field ("en" or "vi")
  - [x] Implement logging node to record detected language
  - [x] Add error handling for invalid or missing language field
  - [x] Create response structure with status and detected language

- [x] Task 4: Implement response formatting (AC: 3)
  - [x] Add response formatting node for JSON output
  - [x] Structure response as `{"status": "received", "language": "[detected_language]"}`
  - [x] Add proper HTTP status codes (200 for success, 400 for errors)
  - [x] Implement Respond to Webhook node for API response

- [x] Task 5: Add request validation and error handling (AC: 2, 3)
  - [x] Add input validation for required fields
  - [x] Implement error responses for malformed requests
  - [x] Add logging for debugging and monitoring
  - [x] Create proper error messages for different failure scenarios

- [x] Task 6: Document webhook URL and usage (AC: 4)
  - [x] Update workflow documentation with webhook URL details
  - [x] Add usage examples and expected request/response formats
  - [x] Document error scenarios and response codes
  - [x] Create README or documentation file for the router agent

- [x] Task 7: Test workflow functionality (AC: 1-4)
  - [x] Test webhook trigger with valid requests
  - [x] Test language detection for both "en" and "vi"
  - [x] Test error handling for invalid requests
  - [x] Verify response format matches requirements
  - [x] Document test results and validation steps

## Dev Notes

### Single API Entry Point Architecture
Based on the coding standards [Source: architecture/coding-standards.md], the Router Agent serves as the single API entry point for the Flutter application:

- **Single Entry Point:** All Flutter app communication must go through `POST /webhook/router`
- **Request Routing:** Router agent determines which specialized agent should handle the request
- **Language Context:** Every request includes language identifier for proper response formatting
- **Future Expansion:** Router will eventually route to specialized agents (data_collector, analyzer, planner, etc.)

### N8N Workflow Patterns
[Source: docs/n8n_config_creation_instructions/ai-agent-chat-api-workflow-example.md]
- Use Webhook node as entry point with POST method
- Implement request parsing and validation
- Add proper error handling and logging
- Use Respond to Webhook node for API responses
- Structure workflow with clear node connections and error paths

### Webhook Configuration Requirements
[Source: docs/n8n_config_creation_instructions/1-trigger-nodes-workflow-entry-points.md]
- **HTTP Method:** POST
- **Path:** `/webhook/router`
- **Response Mode:** responseNode (to handle responses within workflow)
- **Authentication:** Initially none (will be added in future authentication story)

### Request/Response Format
**Expected Request Format:**
```json
{
  "language": "en",  // or "vi"
  // Additional fields will be added in future stories
}
```

**Expected Response Format:**
```json
{
  "status": "received",
  "language": "en"
}
```

**Error Response Format:**
```json
{
  "status": "error",
  "message": "Invalid language field",
  "language": null
}
```

### Language Support Requirements
The router agent must support:
- **English (en):** Default language for international users
- **Vietnamese (vi):** Primary language for Vietnamese market
- **Validation:** Reject invalid language codes
- **Logging:** Record language detection for analytics

### Future Router Agent Evolution
This story creates the foundation for the router agent. Future enhancements will include:
- **Agent Routing:** Route requests to specialized AI agents
- **Authentication:** JWT token validation
- **Rate Limiting:** Request throttling and abuse prevention
- **Load Balancing:** Distribute requests across agent instances
- **Monitoring:** Request tracking and performance metrics

### Development Workflow Integration
[Source: architecture/development-workflow.md]
- Workflow file location: `/n8n-config/agents/04_router_ai.json`
- Import into n8n instance for testing
- Test with curl or Postman before Flutter integration
- Document webhook URL for Flutter app configuration

### Testing Strategy
[Source: architecture/tech-stack.md]
- **Manual Testing:** Use n8n interface to test webhook triggers
- **API Testing:** Use curl/Postman for request/response validation
- **Error Testing:** Test invalid requests and error scenarios
- **Language Testing:** Verify both "en" and "vi" language handling

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-17 | 1.0 | Initial story creation | Scrum Master |
| 2025-09-17 | 1.1 | Story implementation completed | Dev Agent |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
GitHub Copilot (Claude 3.5 Sonnet)

### Debug Log References
*No debugging issues encountered during implementation*

### Completion Notes List
- ✅ Created comprehensive n8n workflow JSON file with 12 nodes
- ✅ Implemented POST webhook trigger at `/webhook/router` path
- ✅ Added dual-layer validation for language field (existence and value)
- ✅ Implemented support for both "en" and "vi" language codes
- ✅ Created comprehensive error handling with proper HTTP status codes
- ✅ Added request logging with timestamp and metadata capture
- ✅ Implemented proper JSON response formatting for success and error cases
- ✅ Added debug logging node for development and troubleshooting
- ✅ Created comprehensive documentation with curl and Postman examples
- ✅ Followed n8n workflow patterns from reference documentation
- ✅ Implemented proper response structure exactly as specified in acceptance criteria
- ✅ Added error codes for different failure scenarios (INVALID_LANGUAGE, MISSING_LANGUAGE)
- ✅ Configured proper Content-Type headers for all responses
- ✅ Created future-ready architecture for routing expansion

### File List
**Created Files:**
- `n8n-config/agents/04_router_ai.json` - Complete n8n Router Agent workflow
- `n8n-config/agents/ROUTER_AGENT_README.md` - Comprehensive documentation and usage guide

**Modified Files:**
- None

**Referenced Files:**
- `docs/n8n_config_creation_instructions/ai-agent-chat-api-workflow-example.md` - N8n workflow patterns
- `docs/n8n_config_creation_instructions/1-trigger-nodes-workflow-entry-points.md` - Webhook configuration
- `docs/architecture/coding-standards.md` - Single API entry point requirements

## QA Results
*Results from QA Agent QA review will be populated here after implementation*
