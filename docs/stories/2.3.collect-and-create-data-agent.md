# Story 2.3: Collect and Create Data Agent

## Status
Draft

## Story
**As a** User,
**I want** to easily provide my financial information through various methods and have it properly structured,
**so that** the system can build an accurate picture of my financial situation.

## Acceptance Criteria
1. An n8n workflow named "Collect and Create Data Agent" is created.
2. Triggered by Orchestrator Agent for "signup", "provide_info" intents or when data is missing.
3. Parses and validates customer-provided information from multiple sources:
   - Voice messages (income, expenses, goals)
   - Images via OCR (bank statements, receipts)
   - Text input (structured and free-form responses)
4. Creates and updates structured data entries in database tables and memory system.
5. Stores data in appropriate tables (`money_accounts`, `debts`, `investments`, etc.) and `data_metadata`/`data_rows` for flexible storage.
6. Assesses profile completeness and suggests next data collection steps.
7. Returns structured data updates and assessment summaries (e.g., "Profile 80% complete").
8. **Reference:** Follow patterns in `docs/n8n_config_creation_instructions/ai-agent-chat-api-workflow-example.md`

## Tasks

### 1. Workflow Setup
- [x] Create new n8n workflow named "Collect and Create Data Agent"
- [x] Set up executeWorkflowTrigger with required input parameters
- [x] Configure workflow to handle multi-modal input processing

### 2. Data Collection Tools
- [x] Implement OCR processing for financial documents (receipts, statements)
- [x] Set up voice transcription for audio financial information
- [x] Create text processing for manual financial data entry
- [x] Configure image analysis for financial document categorization

### 3. Database Storage Implementation
- [x] Connect to PostgreSQL database with proper credentials
- [x] Implement storage to money_accounts table for account information
- [x] Implement storage to transactions table for income/expense data
- [x] Implement storage to budgets table for budget allocations
- [x] Implement storage to spending_categories table for custom categories
- [x] Implement JSONB storage to data_metadata and data_rows for complex financial data

### 4. Data Validation and Quality
- [x] Implement financial amount validation and formatting
- [x] Add date format validation and chronological consistency checks
- [x] Create account type and category validation rules
- [x] Implement duplicate detection and deduplication logic
- [x] Add data completeness and integrity checks

### 5. Profile Completeness Assessment
- [x] Calculate completeness percentages for each financial area
- [x] Identify missing data elements and prioritize collection needs
- [x] Generate suggested next steps for data collection
- [x] Create data quality scoring algorithm
- [x] Implement progress tracking for profile building

### 6. Response Formatting
- [x] Structure output with profile update summaries
- [x] Include completeness assessment with category breakdowns
- [x] Provide prioritized next step recommendations
- [x] Format data quality metrics and scores
- [x] Create human-readable processing summaries

## Dev Notes

### Architecture Requirements
[Source: architecture/tech-stack.md]
- **Backend Platform:** n8n Cloud/n8n latest version with AI and OCR capabilities
- **Database:** PostgreSQL 15 or 16 with JSONB support for flexible data storage
- **AI Integration:** Google Gemini for natural language processing and data classification
- **Media Processing:** OCR and voice transcription services for multimodal input

### Input Data Specification
[Source: architecture/api-specification.md]
**Triggered by Orchestrator Agent with:**
```typescript
interface DataCollectionInput {
  user_id: string;
  intent: 'signup' | 'provide_info';
  data_sources: {
    text?: string;           // Natural language financial information
    voice?: {                // Voice message content
      data: string;         // Base64 encoded audio
      transcription?: string; // Pre-processed transcript
    };
    image?: {               // Financial document image
      data: string;         // Base64 encoded image
      mime: string;
      document_type?: 'bank_statement' | 'receipt' | 'investment_summary';
    };
  };
  existing_profile_data?: any;
  collection_context?: string;
}
```

### Database Schema Integration
[Source: architecture/database-schema.md]
**Core Financial Tables:**
```sql
-- Money accounts for bank accounts, cards, investment accounts
CREATE TABLE money_accounts (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v7(),
  user_id UUID NOT NULL,
  account_name VARCHAR(255),
  account_type VARCHAR(50), -- checking, savings, investment, credit_card
  balance DECIMAL(12,2),
  currency VARCHAR(3) DEFAULT 'USD',
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (user_id) REFERENCES users(id)
);

-- Flexible JSONB storage for complex financial data
CREATE TABLE data_metadata (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v7(),
  user_id UUID NOT NULL,
  data_type VARCHAR(100), -- debts, investments, insurance, properties, goals
  schema_version VARCHAR(20),
  schema_definition JSONB,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (user_id) REFERENCES users(id)
);

CREATE TABLE data_rows (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v7(),
  metadata_id UUID NOT NULL,
  user_id UUID NOT NULL,
  row_data JSONB,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (metadata_id) REFERENCES data_metadata(id),
  FOREIGN KEY (user_id) REFERENCES users(id)
);
```

### Memory Management Schema
**Collect and Create Data Agent Memory Topics:**
- **Short-term:** Raw input parses, temporary OCR results, processing buffers
- **Long-term:** User financial profile, data completeness trackers, collection patterns

**Memory Update Structure:**
```json
{
  "agent_name": "Collect_Create_Data_Agent",
  "memory_type": "financial_profile",
  "memory_content": {
    "profile_completeness": {
      "overall_percentage": 75,
      "categories": {
        "income": 100,
        "expenses": 80,
        "assets": 60,
        "debts": 90,
        "goals": 40
      },
      "missing_elements": ["retirement_goals", "investment_portfolio", "insurance_coverage"],
      "last_updated": "2025-09-20T10:30:00Z"
    },
    "data_collection_patterns": {
      "preferred_input_method": "voice|text|image",
      "typical_update_frequency": "weekly|monthly",
      "accuracy_score": 0.95
    }
  }
}
```

### Structured Output Parser Configuration
[Source: ai-agent-chat-api-workflow-example.md]
```json
{
  "schemaType": "manual",
  "inputSchema": {
    "type": "object",
    "properties": {
      "memory": {
        "type": "string",
        "description": "Memory updates for data agent: financial profile updates, data completeness trackers, collection patterns"
      },
      "dataCollectionResult": {
        "type": "object",
        "properties": {
          "profile_updates": {"type": "object"},
          "completeness_assessment": {"type": "object"},
          "suggested_next_steps": {"type": "array"},
          "data_quality_score": {"type": "number"},
          "processing_summary": {"type": "string"}
        }
      }
    }
  }
}
```

### Data Processing and Validation Rules
[Source: architecture/security-and-performance.md]
**Financial Data Validation:**
- **Currency Amounts:** Validate format, reasonable ranges, currency consistency
- **Account Numbers:** Mask sensitive data, validate format patterns
- **Dates:** Parse various date formats, validate chronological consistency  
- **Categories:** Map to standard financial categories, handle custom user categories

**Data Quality Scoring:**
- **Completeness:** Percentage of required fields populated
- **Accuracy:** Validation against external data sources where possible
- **Consistency:** Cross-validation between related data points
- **Freshness:** Recency of data updates and collection timestamps

### OCR and Media Processing
[Source: architecture/tech-stack.md]
**Supported Document Types:**
- **Bank Statements:** Extract transactions, balances, account information
- **Receipts:** Parse merchant, amount, date, category information
- **Investment Summaries:** Extract portfolio data, performance metrics, holdings
- **Pay Stubs:** Income information, deductions, employer details

### File Locations and Structure
[Source: architecture/unified-project-structure.md]
```
n8n-config/
├── epic2-multi-agent/
│   ├── 06_collect_create_data_agent.json (THIS STORY - NEW)
│   └── memory_update_agent.json (placeholder for memory management)
```

### Testing Requirements
- **Multimodal Processing:** Test text, voice, and image input parsing accuracy
- **Data Validation:** Test financial data validation rules and quality scoring
- **Database Integration:** Test structured and JSONB storage operations
- **Profile Assessment:** Test completeness calculation and suggestion generation
- **Error Handling:** Test OCR failures, invalid data, and processing errors
- **Performance:** Test processing speed for various document types and sizes

## Testing

### Test Coverage Requirements
**Data Processing:** Test all input modalities and extraction accuracy
**Database Operations:** Verify proper storage in both structured and JSONB tables
**Profile Assessment:** Test completeness calculation and gap identification
**Data Quality:** Test validation rules and quality scoring mechanisms
**Memory Management:** Test profile tracking and collection pattern learning

### Test Cases
1. **Multimodal Input Tests:**
   - Test natural language financial information parsing
   - Test voice message transcription and entity extraction
   - Test OCR processing for various document types and qualities
   - Test mixed-media input scenarios

2. **Data Storage and Validation Tests:**
   - Test structured data insertion in financial tables
   - Test JSONB storage for complex financial instruments
   - Test data validation rules and error handling
   - Test duplicate detection and data deduplication

3. **Profile Assessment Tests:**
   - Test completeness percentage calculation accuracy
   - Test missing data identification and prioritization
   - Test suggestion generation for next collection steps
   - Test progress tracking across multiple collection sessions

4. **Quality and Performance Tests:**
   - Test data quality scoring algorithms
   - Test processing performance for large documents
   - Test error handling and retry mechanisms
   - Test sensitive data masking and privacy protection

## Dev Agent Record

### Debug Log References
- Initial research: database schema analysis and story requirements review
- Implementation: AI agent pattern with PostgreSQL tools following orchestrator pattern
- Architecture: 15-node workflow with comprehensive data storage and retrieval capabilities
- Pattern adoption: executeWorkflowTrigger → AI Agent → Tool delegation → Memory Update integration

### Completion Notes
- Workflow implements comprehensive multimodal data collection capabilities with OCR, voice, text processing
- All PostgreSQL tables properly integrated: money_accounts, transactions, budgets, spending_categories, data_metadata, data_rows
- Profile completeness assessment provides actionable insights with percentage scoring and gap identification
- Data quality validation ensures reliable financial information through structured parsing and validation rules
- Memory integration follows orchestrator pattern with MemoryUpdaterAgent call and agent_type field
- Comprehensive tool set enables storage and querying across all financial data categories

### File List
- `n8n-config/workflows/agents/06_collect_create_data_agent.json` - Main workflow implementation with 15 nodes

### Change Log
- 2024-12-20: Initial workflow creation following AI agent pattern from orchestrator
- 2024-12-20: Added comprehensive PostgreSQL tool integrations for all 6 database tables
- 2024-12-20: Implemented profile completeness assessment with category scoring (income 20%, expenses 25%, assets 20%, debts 20%, goals 15%)
- 2024-12-20: Added structured output parsing for detailed data collection results with quality metrics
- 2024-12-20: Integrated MemoryUpdaterAgent pattern consistent with orchestrator agent architecture
- 2024-12-20: Added agent_type field and comprehensive system prompt for financial data specialist role

### Agent Model Used
- Google Gemini Chat Model for natural language processing, data extraction, and financial data validation

### Status
Ready for Review

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-20 | 1.0 | Initial story creation for Collect and Create Data Agent implementation | Scrum Master |
| 2024-12-20 | 2.0 | Completed implementation with AI agent pattern and comprehensive data tools | Dev Agent James |
