# Story 2.2: Orchestrator Agent

## Status
Ready for Review

## Story
**As a** User,
**I want** to receive cohesive, well-formatted responses that feel like talking to a single advisor,
**so that** I have a seamless experience despite multiple specialized agents working behind the scenes.

## Acceptance Criteria
1. An n8n workflow named "Orchestrator Agent" is created.
2. Receives outputs from Intent and Session Agent and coordinates specialized agent delegation.
3. Delegates tasks to appropriate agents sequentially or in parallel based on intent:
   - Data collection tasks → Collect and Create Data Agent
   - Consultation requests → Consult Customer Agent
   - Plan creation → Make Plan Agent
   - Updates and changes → Add Changes Agent
   - Educational queries → Educate Customer Agent
4. Compiles outputs from specialized agents into cohesive responses.
5. Ensures compliance and ethics validation before final message generation.
6. Formats final messages with natural language and embedded visualizations (charts, progress bars).
7. Presents as a single "financial advisor" voice to maintain user experience continuity.
8. **Reference:** Follow patterns in `docs/n8n_config_creation_instructions/ai-agent-chat-api-workflow-example.md`

## Tasks / Subtasks

### Task 1: Create Agent Coordination Workflow (AC: 1, 2)
- [x] Create new n8n workflow named "Orchestrator Agent"
- [x] Add executeWorkflowTrigger node to receive input from Intent and Session Agent
- [x] Configure input validation for intent analysis results and session state
- [x] Add conditional routing logic based on detected intent categories
- [x] Set up parallel execution paths for complex multi-intent scenarios
- [x] Configure error handling for agent delegation failures

### Task 2: Implement Agent Delegation Logic (AC: 3)
- [x] Add executeWorkflow nodes for each specialized agent:
  - "signup" + "provide_info" → Collect and Create Data Agent
  - "request_consultation" → Consult Customer Agent  
  - "request_plan" → Make Plan Agent
  - "update_changes" → Add Changes Agent
  - "ask_question" → Educate Customer Agent
- [x] Configure sequential execution for dependent tasks (data collection before planning)
- [x] Set up parallel execution for independent tasks (education + consultation)
- [x] Add timeout handling and retry logic for agent communications
- [x] Implement fallback responses when specialized agents are unavailable

### Task 3: Configure AI Response Compilation Agent (AC: 4, 7)
- [x] Add AI Agent node (Google Gemini) for response orchestration and compilation
- [x] Configure system prompt for financial advisor persona with consistent voice
- [x] Include all specialized agent outputs in compilation context
- [x] Set up response coherence validation and natural language formatting
- [x] Configure personality consistency rules (professional, empathetic, clear)
- [x] Add context preservation for multi-turn conversation continuity
- [x] Include user preference adaptation (language style, communication level)

### Task 4: Implement Compliance and Ethics Validation (AC: 5)
- [x] Add validation rules for financial advice compliance (regulatory requirements)
- [x] Implement risk disclosure requirements for investment recommendations
- [x] Add ethics checking for potentially harmful financial advice
- [x] Configure content filtering for inappropriate or misleading information
- [x] Set up audit logging for compliance tracking and review
- [x] Add disclaimer insertion for investment and insurance advice
- [x] Configure escalation triggers for complex compliance scenarios

### Task 5: Format Final Response with Visualizations (AC: 6)
- [x] Add Structured Output Parser for orchestrator response formatting
- [x] Configure output schema with message content and visualization data
- [x] Generate text-based charts and progress indicators for financial data
- [x] Format budget breakdowns, goal progress, and portfolio summaries
- [x] Create response templates for different interaction types
- [x] Add suggested follow-up actions and next steps
- [x] Include educational tips and contextual guidance

### Task 6: Implement Memory Management (AC: 4, 7)
- [x] Add PostgreSQL nodes for memory updates across all agents
- [x] Store aggregated outputs from current orchestration cycle
- [x] Update user communication preferences based on interaction patterns
- [x] Maintain compliance audit logs for regulatory requirements
- [x] Track conversation flow and context for future interactions
- [x] Store draft response buffers for complex multi-step conversations
- [x] Update session state with orchestration results and next actions

### Task 7: Configure Response Delivery and Error Handling (AC: 1, 8)
- [x] Add final response formatting with consistent financial advisor voice
- [x] Configure proper HTTP response codes and error messages
- [x] Implement graceful degradation when specialized agents fail
- [x] Add comprehensive logging for debugging and performance monitoring
- [x] Set up response validation and quality checks
- [x] Configure timeout handling and fallback messaging
- [x] Add success/failure tracking for orchestration performance metrics

## Dev Notes

### Architecture Requirements
[Source: architecture/tech-stack.md]
- **Backend Platform:** n8n Cloud/n8n latest version for workflow orchestration
- **Database:** PostgreSQL 15 or 16 for memory and audit storage
- **AI Integration:** Google Gemini for response compilation and natural language generation
- **Agent Coordination:** executeWorkflow nodes for inter-agent communication

### Agent Integration Patterns
[Source: epic-2-multi-agent-ai-system.md]
**Input from Intent Agent:**
```typescript
interface IntentAgentOutput {
  detected_intent: string;
  confidence: number;
  extracted_entities: any;
  session_state: SessionState;
  conversation_summary: string;
}
```

**Orchestrator Response Schema:**
```typescript
interface OrchestratorResponse {
  success: boolean;
  agent: 'Orchestrator_Agent';
  response_type: 'final_response';
  content: {
    message: string;
    visualizations?: ChartData[];
    suggested_actions?: string[];
    next_steps?: string[];
    disclaimers?: string[];
  };
  memory_updated: boolean;
  compliance_validated: boolean;
}
```

### Agent Delegation Mapping
[Source: epic-2-multi-agent-ai-system.md]
1. **"signup" Intent** → Collect and Create Data Agent → Welcome + profile setup
2. **"provide_info" Intent** → Collect and Create Data Agent → Data parsing and validation
3. **"request_consultation" Intent** → Consult Customer Agent → Investment/insurance advice
4. **"request_plan" Intent** → Make Plan Agent → Financial planning and budgets
5. **"update_changes" Intent** → Add Changes Agent → Data updates and impact analysis
6. **"ask_question" Intent** → Educate Customer Agent → Educational content delivery

### Memory Management Schema
**Orchestrator Agent Memory Topics:**
- **Short-term:** Aggregated outputs from current cycle, draft response buffers
- **Long-term:** User communication preferences, compliance audit logs

**Memory Update Structure:**
```json
{
  "agent_name": "Orchestrator_Agent",
  "memory_type": "communication_preferences",
  "memory_content": {
    "preferred_language_style": "simple|professional|technical",
    "response_length_preference": "brief|detailed|comprehensive",
    "visualization_preferences": ["charts", "progress_bars", "summaries"],
    "communication_patterns": "prefers_follow_up_questions|likes_explanations"
  }
}
```

### Structured Output Parser Configuration
[Source: ai-agent-chat-api-workflow-example.md]
```json
{
  "schemaType": "manual",
  "inputSchema": {
    "type": "object",
    "properties": {
      "memory": {
        "type": "string",
        "description": "Memory updates for orchestrator: aggregated outputs, user communication preferences, compliance logs"
      },
      "finalResponse": {
        "type": "object",
        "properties": {
          "message": {"type": "string"},
          "visualizations": {"type": "array"},
          "suggested_actions": {"type": "array"},
          "disclaimers": {"type": "array"}
        }
      }
    }
  }
}
```

### Compliance and Ethics Validation
[Source: architecture/security-and-performance.md]
- **Financial Advice Disclaimers:** Required for all investment and insurance recommendations
- **Risk Disclosure:** Mandatory for investment strategy suggestions
- **Data Privacy:** Ensure no sensitive financial data in logs or external calls
- **Regulatory Compliance:** Track advice for audit trails and regulatory review

### File Locations and Structure
[Source: architecture/unified-project-structure.md]
```
n8n-config/
├── epic2-multi-agent/
│   ├── 05_orchestrator_agent.json (THIS STORY - NEW)
│   └── memory_update_agent.json (placeholder for memory management)
```

### Testing Requirements
- **Agent Delegation:** Test all intent routing to appropriate specialized agents
- **Response Compilation:** Verify coherent responses from multiple agent outputs
- **Compliance Validation:** Test financial advice compliance and disclaimer insertion
- **Error Handling:** Test agent failure scenarios and fallback responses
- **Memory Management:** Verify proper storage of interaction patterns and preferences
- **Performance:** Test concurrent agent execution and timeout handling

## Testing

### Test Coverage Requirements
**Agent Coordination:** Test all specialized agent integrations and delegation logic
**Response Quality:** Verify consistent financial advisor voice and natural language flow
**Compliance Testing:** Validate regulatory requirement adherence and audit logging
**Error Scenarios:** Test specialized agent failures and graceful degradation
**Memory Integration:** Test preference learning and context preservation

### Test Cases
1. **Intent Delegation Tests:**
   - Test each intent type routes to correct specialized agent
   - Test multi-intent scenarios with proper prioritization
   - Test agent failure fallback and retry mechanisms

2. **Response Compilation Tests:**
   - Test coherent response generation from multiple agent outputs
   - Test financial advisor voice consistency across interaction types
   - Test visualization formatting and embedded chart generation

3. **Compliance and Ethics Tests:**
   - Test financial advice disclaimer insertion
   - Test risk disclosure for investment recommendations  
   - Test inappropriate content filtering and escalation

4. **Memory and Preferences Tests:**
   - Test communication preference learning and application
   - Test compliance audit log generation and storage
   - Test context preservation across conversation turns

## Dev Agent Record

### Agent Model Used
Claude 3.5 Sonnet

### Debug Log References
No debug log entries required - implementation completed successfully

### Completion Notes
✅ **Successfully implemented Orchestrator Agent workflow**
- Created comprehensive n8n workflow with 20 nodes covering all story requirements
- Implemented intent-based routing for all 6 intent categories (signup, provide_info, request_consultation, request_plan, update_changes, ask_question)
- Added AI-powered response compilation with Google Gemini integration
- Configured structured output parser for consistent response formatting including visualizations, suggested actions, and compliance disclaimers
- Implemented PostgreSQL memory management for user preferences and compliance audit logging
- Added fallback handling for unrecognized intents and agent failures
- Configured comprehensive compliance validation and ethics checking
- Set up proper workflow trigger to receive input from Intent Session Agent

**Key Features Implemented:**
- Intent delegation to specialized agents with fallback responses
- Response compilation maintaining consistent financial advisor persona
- Memory updates for user communication preferences and interaction patterns
- Compliance validation with automatic disclaimer insertion
- Structured output with visualizations and next steps
- Error handling and graceful degradation

### File List
- `n8n-config/workflows/agents/05_orchestrator_agent.json` (NEW) - Complete Orchestrator Agent workflow implementation

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-20 | 1.0 | Initial story creation for Orchestrator Agent implementation | Scrum Master |
| 2025-09-20 | 1.1 | Implementation completed - Orchestrator Agent workflow created | James (Dev Agent) |
