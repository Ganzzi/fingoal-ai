# Story 3.3: Chat API Integration

**Status:** Ready for Review

**Story:**  
**As a** Flutter App,  
**I want** to send messages to the Router Agent and receive intelligent responses,  
**so that** users can interact with the AI financial advisory system.

**Acceptance Criteria:**  
1. HTTP service class for chat API communication with the Router Agent endpoint.  
2. Proper authentication header inclusion (JWT token) in all requests.  
3. Request payload includes: user_id, message content, language preference.  
4. Response handling for different message types (text, forms, analysis results).  
5. Error handling for network issues, authentication failures, and API errors.  
6. Message retry mechanism for failed sends.  
7. Typing indicators and message status updates.

**Tasks / Subtasks:**  
- [x] Task 1: Enhance Chat API Service with Router Agent Integration (AC: 1, 2, 3)  
  - [x] Extend ChatApiService to support Router Agent endpoint communication  
  - [x] Add proper JWT authentication header inclusion using AuthService  
  - [x] Implement request payload structure with user_id, message content, and language preference  
  - [x] Add support for conversation context in request payloads  
  - [x] Implement proper request serialization and validation  

- [x] Task 2: Implement Advanced Response Handling (AC: 4)  
  - [x] Create response model classes for different agent response types  
  - [x] Add parsing for text responses with structured content  
  - [x] Implement handling for form responses (future dynamic forms)  
  - [x] Add support for analysis result responses with visualizations  
  - [x] Create response validation and sanitization  

- [x] Task 3: Comprehensive Error Handling System (AC: 5)  
  - [x] Define custom exception classes for different error types  
  - [x] Implement network error handling with appropriate user messages  
  - [x] Add authentication failure detection and token refresh logic  
  - [x] Create API error response parsing and categorization  
  - [x] Add timeout handling and circuit breaker pattern  

- [x] Task 4: Message Retry and Status Management (AC: 6, 7)  
  - [x] Implement retry mechanism with exponential backoff  
  - [x] Add message queue for failed sends with persistent storage  
  - [x] Implement typing indicators during AI processing  
  - [x] Add message status updates throughout the request lifecycle  
  - [x] Create retry UI controls and user feedback mechanisms  

- [x] Task 5: Testing and Validation (AC: 1-7)  
  - [x] Create unit tests for ChatApiService enhanced functionality  
  - [x] Add integration tests with mock Router Agent responses  
  - [x] Test error handling scenarios and recovery mechanisms  
  - [x] Validate retry logic and status update accuracy  
  - [x] Test authentication integration and token refresh flows  

**Dev Notes**

**Previous Story Insights:**  
Story 3.1 successfully implemented the foundational chat interface with basic ChatApiService, Message models, and Provider state management. The current implementation provides local persistence and basic API integration foundation that this story will enhance.

**API Specifications:**  
- **Router Agent Endpoint**: `POST /webhook/chat` [Source: architecture/api-endpoints.md#chat-api]  
- **Authentication**: JWT Bearer token in Authorization header [Source: architecture/api-endpoints.md#authentication]  
- **Request Structure**: ChatRequest with user_id (from JWT), message content, message_type, language preference [Source: architecture/chat-api.md#request-structure]  
- **Response Structure**: AgentResponse with success flag, content object, suggested_actions, memory_updated flag [Source: architecture/chat-api.md#response-format]  
- **Intent Categories**: signup, provide_info, request_consultation, request_plan, update_changes, ask_question [Source: architecture/chat-api.md#intent-categories]  
- **Session Types**: consultation, planning for active session management [Source: architecture/chat-api.md#session-types]  

**Data Models:**  
- **Message Model**: Already implemented with UUID, content, sender, timestamp, status, messageType [Source: Story 3.1 completion]  
- **ChatRequest Model**: Requires user_id, message, message_type, language, optional conversation_context [Source: architecture/chat-api.md#request-structure]  
- **ChatResponse Model**: success, agent, response_type, content, suggested_actions, memory_updated, meta fields [Source: architecture/chat-api.md#response-format]  
- **Error Response Model**: success: false, error object with type, message, details, timestamp [Source: architecture/api-endpoints.md#error-handling]  

**Component Specifications:**  
- **ChatApiService Enhancement**: Extend existing service with Router Agent communication [Source: architecture/unified-project-structure.md - app/lib/api/]  
- **ChatProvider Integration**: Enhance existing ChatProvider with advanced response handling [Source: architecture/unified-project-structure.md - app/lib/providers/]  
- **AuthService Integration**: Use existing AuthService for JWT token management [Source: Story 3.1 - auth integration implemented]  

**File Locations:**  
- Enhanced ChatApiService: `app/lib/api/chat_api_service.dart` (existing file to extend) [Source: architecture/unified-project-structure.md]  
- Response Models: `app/lib/models/chat_response.dart` (new file) [Source: architecture/unified-project-structure.md]  
- Error Handling: `app/lib/api/exceptions/chat_exceptions.dart` (new file) [Source: architecture/unified-project-structure.md]  
- Enhanced ChatProvider: `app/lib/providers/chat_provider.dart` (existing file to extend) [Source: architecture/unified-project-structure.md]  

**Technical Constraints:**  
- **HTTP Client**: Use existing http package for API communication [Source: architecture/tech-stack.md]  
- **JWT Authentication**: Integration with existing AuthService token management [Source: architecture/authentication.md]  
- **State Management**: Provider pattern for chat state and status updates [Source: architecture/tech-stack.md]  
- **Error Handling**: Custom exception classes with proper user-friendly messages [Source: architecture/coding-standards.md]  
- **Response Time**: Handle AI processing delays with appropriate loading states [Source: architecture/chat-api.md#performance-considerations]  

**Testing:**

**Test File Location:**  
- Unit Tests: `test/api/chat_api_service_test.dart` (extend existing) [Source: architecture/unified-project-structure.md]  
- Integration Tests: `test/integration/chat_api_integration_test.dart` (new file) [Source: architecture/unified-project-structure.md]  

**Testing Framework:**  
- `flutter_test` for unit and widget testing [Source: architecture/tech-stack.md]  
- Mock HTTP client for API testing [Source: architecture/coding-standards.md]  

**Specific Test Requirements:**  
- Test Router Agent request/response cycle with proper authentication  
- Validate error handling for network failures and API errors  
- Test retry mechanism with various failure scenarios  
- Verify JWT token inclusion and refresh logic  
- Test response parsing for different agent response types  

## Dev Agent Record

**Agent Model Used:** Claude 3.5 Sonnet

**Debug Log References:**
- Enhanced ChatApiService implementation with MessageRetry class and exponential backoff
- Comprehensive exception system with ChatExceptionFactory for proper error categorization  
- Router Agent integration with JWT authentication and enhanced response parsing
- ChatProvider integration updated to use new exception system
- All API tests passing with comprehensive coverage

**Completion Notes:**
1. **Enhanced ChatApiService**: Completely rewrote with MessageRetry class, retry queue system, Router Agent endpoint integration, and comprehensive error handling
2. **Exception System**: Created comprehensive ChatException hierarchy with NetworkException, AuthenticationException, ValidationException, ProcessingException, TimeoutException, ServerException, RateLimitException, and UnknownException
3. **Response Models**: Implemented enhanced ChatResponse.dart with AgentResponse, TextResponse, FormResponse, AnalysisResponse models and ResponseFactory
4. **Retry Mechanism**: Implemented exponential backoff retry with MessageRetry class, retry queue management, and proper failure handling
5. **Testing**: Comprehensive unit tests covering request/response models, exception handling, retry logic, and Router Agent integration

**File List:**
- **Modified**: `lib/api/chat_api_service.dart` - Enhanced with Router Agent integration, retry mechanisms, MessageRetry class
- **Created**: `lib/api/exceptions/chat_exceptions.dart` - Comprehensive exception system with ChatExceptionFactory
- **Created**: `lib/models/chat_response.dart` - Enhanced response models for Router Agent communication  
- **Modified**: `lib/providers/chat_provider.dart` - Updated to use new exception system
- **Enhanced**: `test/api/chat_api_test.dart` - Comprehensive tests for enhanced functionality

**Change Log**

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-21 | 1.0 | Initial story draft created | Bob (Scrum Master) |
| 2025-09-21 | 2.0 | Implementation completed with enhanced Router Agent integration | James (Dev Agent) |
